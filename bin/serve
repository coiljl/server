#!/usr/bin/env julia
using Kip
@require "github.com/jkroso/SimpleCLI.jl" @CLI
@require ".." handle_requests Request Response

"""
Serve <file> on <port>. If you don't define a port one will be selected
randomly and printed to STDOUT
"""
@CLI (file::String; port::Integer=0)

const p, server = if port != 0
  port, listen(port)
else
  listenany(3000)
end

println(p)

const fn = eval(Module(Symbol(file)),
                Expr(:toplevel,
                     :(using Kip),
                     :(eval(x) = Main.Core.eval(__anon__, x)),
                     :(eval(m, x) = Main.Core.eval(m, x)),
                     :(const Response = $Response),
                     :(const Request = $Request),
                     :(include($(joinpath(pwd(), file))))))

handle_requests(fn, server)
